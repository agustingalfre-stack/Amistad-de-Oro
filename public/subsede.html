<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üìç Sub Sede - Amistad de Oro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* ================= Variables CSS ================= */
    :root {
      /* Fondos */
      --bg-body: #222222;
      --bg-card: #b1b1b1;
      --bg-table: #b1b1b1;

      /* Texto */
      --text-main: #222222;
      --text-light: #ffffff;
      --text-muted: #888888;

      /* Botones */
      --btn-success: #009c4f;
      --btn-secondary: #6c757d;
      --btn-warning: #eba900;
      --btn-danger: #e2271d;
      --btn-info: #ee7067;
      --btn-primary: #ca328a;

      /* Bordes */
      --border-main: #444444;

      /* Escudos / Chips */
      --escudo-bg: #b1b1b1;
      --chip-bg: #2a2a2a;
      --chip-hover: #444444;

      /* Resaltado de jornadas */
      --jornada-bg: #dddddd;

      /* Nuevas variables para filas */
      --row-bg: #ffffff;            /* Fondo de fila normal */
      --row-hover: #3d3d3d;         /* Fondo al pasar el mouse */
      --row-alt-bg: #ffffff;        /* Fondo alternado (zebra) */
      --row-text: #ffffff;          /* Color de texto */
    }

    /* ================= Estilos globales ================= */
    body {
      background: var(--bg-body);
      color: var(--text-main);
      padding: 20px;
    }
    h1 {
      color: var(--text-light);
    }
    h2 {
      color: var(--text-mail);
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-main);
      border-radius: 10px;
      margin-top: 20px;
      padding: 15px;
    }
    .btn {
      border-radius: 8px;
    }
    input, select {
      background: #888787 !important;
      color: var(--text-light) !important;
      border: 1px solid var(--border-main) !important;
    }
    th, td {
      color: var(--text-light);
      vertical-align: middle !important;
    }
    .table {
      border-color: var(--border-main);
    }
    #nombreSubsede {
      font-size: 3rem;
      font-weight: 700;
    }
    ul li {
      background: var(--chip-bg);
      border: none;
      margin-top: 5px;
    }

    /* ================= Equipos ================= */
    .equipos-container {
      background: var(--bg-card);
      border: 1px solid var(--border-main);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .equipo-chip {
      display: inline-block;
      background: var(--chip-bg);
      color: var(--text-light);
      border: 1px solid var(--border-main);
      border-radius: 20px;
      padding: 6px 14px;
      margin: 5px;
      font-size: 0.95rem;
      transition: 0.3s;
    }
    .equipo-chip:hover {
      background: var(--chip-hover);
      transform: scale(1.05);
    }

    /* ================= Botones ================= */
    .btn-ver {
      background: var(--btn-warning);
      color: var(--text-main);
      font-weight: 600;
      border: none;
    }
    .btn-ver:hover {
      background: #c4890e;
      color: var(--text-main);
    }
    .btn-info {
      background: var(--btn-info);
      color: var(--text-main);
      border: none;
    }
    .btn-primary {
      background: var(--btn-primary);
      color: var(--text-main);
      border: none;
    }
    .btn-danger {
      background: var(--btn-danger);
      color: var(--text-main);
      border: none;
    }

    /* ================= Escudos ================= */
    .escudo-equipo {
      object-fit: contain;
      background: var(--escudo-bg);
      border-radius: 8px;
      padding: 4px;
      border: 1px solid var(--border-main);
    }

    /* ================= Jornadas ================= */
    .table-secondary {
      background: var(--jornada-bg) !important;
      color: var(--text-main) !important;
      cursor: pointer;
    }

    /* === TABLAS === */
    .table-dark {
      border-color: var(--color-border);
    }

    .table-dark tbody tr {
      background-color: var(--row-bg);
      color: var(--row-text);
      transition: background-color 0.3s ease;
    }

    .table-dark tbody tr:nth-child(even) {
      background-color: var(--row-alt-bg);
    }

    .table-dark tbody tr:hover {
      background-color: var(--row-hover);
    }

    .table-secondary {
      background-color: var(--color-accent);
      color: #111;
      font-weight: 600;
    }

    .flecha {
      font-size: 1.2rem;
    }

    #tablaPosiciones td:last-child {
      font-weight: bold;
      color: #ffffff; /* dorado para destacar los puntos */
    }
  </style>
</head>
<body>
  <div class="container mb-3">
    <h1 id="nombreSubsede">Cargando...</h1>
  </div>

  <div class="container">
    <div class="d-flex justify-content-between mb-3">
      <button class="btn btn-secondary" onclick="volver()">‚¨ÖÔ∏è Volver</button>
    </div>

    <!-- CARD EQUIPOS -->
    <div class="card">
      <h2>üë• Equipos</h2>
      <div class="input-group mb-3">
        <input type="text" id="nombreEquipo" class="form-control" placeholder="Nombre del equipo">
        <input type="file" id="escudoEquipo" accept="image/*" class="form-control">
        <button class="btn btn-success" onclick="agregarEquipo()">Agregar</button>
      </div>
      <ul id="listaEquipos" class="list-group"></ul>
    </div>

    <!-- CARD FIXTURE -->
    <div class="card">
      <h2>Fixture</h2>
      <div class="row g-2 mb-3">
        <div class="col-md-3">
          <select id="equipoLocal" class="form-control"></select>
        </div>
        <div class="col-md-3">
          <select id="equipoVisitante" class="form-control"></select>
        </div>
        <div class="col-md-2">
          <input type="date" id="fechaPartido" class="form-control">
        </div>
        <div class="col-md-2">
          <input type="time" id="horaPartido" class="form-control">
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-success" id="btnGuardar" onclick="agregarPartido()">Agregar Partido</button>
        </div>
        <div class="d-flex justify-content-end mb-2">
          <button class="btn btn-warning" onclick="descargarPDF()">Descargar PDF</button>
        </div>
      </div>

      <table class="table table-dark table-striped">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Local</th>
            <th></th>
            <th>Visitante</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="listaFixture">
          <!-- Aqu√≠ se cargar√°n los partidos -->
        </tbody>
      </table>
    </div>

    <!-- CARD RESULTADOS -->
    <div class="card">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">Resultados</h2>
    <button class="btn btn-warning" onclick="descargarResultadosPDF()">Descargar PDF</button>
  </div>
  <table class="table table-dark table-striped">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Local</th>
            <th>‚öΩ</th>
            <th>‚öΩ</th>
            <th>Visitante</th>
          </tr>
        </thead>
        <tbody id="listaResultados"></tbody>
      </table>
    </div>

    <!-- üèÜ CARD TABLA DE POSICIONES -->
    <div class="card">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="mb-0">Tabla de Posiciones</h2>
        <button class="btn btn-warning" onclick="descargarPosicionesPDF()">Descargar PDF</button>
      </div>
      <table class="table table-dark table-striped">
        <thead>
          <tr>
            <th>#</th>
            <th>Equipo</th>
            <th>PJ</th>
            <th>G</th>
            <th>E</th>
            <th>P</th>
            <th>GF</th>
            <th>GC</th>
            <th>DG</th>
            <th>Pts</th>
          </tr>
        </thead>
        <tbody id="tablaPosiciones"></tbody>
      </table>
    </div>
  </div>

  <script>
const API = 'http://localhost:3000';
const params = new URLSearchParams(window.location.search);
const subsedeId = parseInt(params.get('id'));
let equipos = [], fixture = [];
let editandoId = null;

// ---------- Cargar nombre de la subsede ----------
async function cargarNombreSubsede() {
  const nombreElem = document.getElementById('nombreSubsede');
  try {
    const res = await fetch(`${API}/subsede/${subsedeId}`);
    const subsede = await res.json();
    nombreElem.textContent = subsede.nombre || 'Sub Sede desconocida';
  } catch {
    nombreElem.textContent = 'Sub Sede desconocida';
  }
}

// =======================
// üîπ EQUIPOS
// =======================

async function cargarEquipos() {
  try {
    const res = await fetch(`${API}/equipos/${subsedeId}`);
    equipos = await res.json(); // ‚ö° actualiza la variable global

    const lista = document.getElementById('listaEquipos');
    const selectLocal = document.getElementById('equipoLocal');
    const selectVisitante = document.getElementById('equipoVisitante');

    lista.innerHTML = '';
    selectLocal.innerHTML = '<option value="">-- Local --</option>';
    selectVisitante.innerHTML = '<option value="">-- Visitante --</option>';

    if (equipos.length === 0) {
      lista.innerHTML = '<li class="list-group-item text-muted">No hay equipos cargados.</li>';
      return;
    }

    equipos.forEach(eq => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          ${eq.escudo ? `<img src="${API}${eq.escudo}" alt="${eq.nombre}" width="50" height="50" class="escudo-equipo">` : ''}
          <span id="equipo-nombre-${eq.id}" class="fw-semibold">${eq.nombre}</span>
        </div>
        <div>
          <!-- ‚ö†Ô∏è Forzamos href a jugadores.html -->
          <a href="jugadores.html?equipoId=${eq.id}&subsedeId=${subsedeId}" class="btn btn-sm btn-info me-2">üë•</a>
          <button class="btn btn-sm btn-primary me-1" onclick="editarEquipoInline(${eq.id})">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger" onclick="eliminarEquipo(${eq.id})">‚ùå</button>
        </div>`;
      lista.appendChild(li);

      selectLocal.innerHTML += `<option value="${eq.id}">${eq.nombre}</option>`;
      selectVisitante.innerHTML += `<option value="${eq.id}">${eq.nombre}</option>`;
    });

  } catch (error) {
    console.error('Error cargando equipos:', error);
    mostrarToast('‚ùå Error cargando equipos', 'error');
  }
}

// ‚ûï Agregar equipo
async function agregarEquipo() {
  const nombre = document.getElementById("nombreEquipo").value.trim();
  const escudo = document.getElementById("escudoEquipo").files[0];
  if (!nombre || !escudo) return alert("Complete los campos");

  const formData = new FormData();
  formData.append("nombre", nombre);
  formData.append("escudo", escudo);
  formData.append("subsedeId", subsedeId);

  await fetch(`${API}/equipos`, {
    method: "POST",
    body: formData
  });

  document.getElementById("nombreEquipo").value = "";
  document.getElementById("escudoEquipo").value = "";
  await cargarEquipos(); // üëà esto actualiza la lista sin recargar la p√°gina
}

// üóëÔ∏è Eliminar equipo
async function eliminarEquipo(id) {
  if (!confirm('¬øEliminar este equipo y todos sus jugadores?')) return;

  try {
    const res = await fetch(`${API}/equipos/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('Error al eliminar equipo');

    // üîπ 1. Recargar lista de equipos
    await cargarEquipos();

    // üîπ 2. Recargar fixture filtrando partidos con equipos existentes
    await cargarFixture();

    // üîπ 3. Recargar resultados filtrando equipos eliminados
    await cargarResultados();

    // üîπ 4. Actualizar tabla de posiciones
    await actualizarTablaPosiciones();

    mostrarToast('üóëÔ∏è Equipo eliminado correctamente');

  } catch (error) {
    console.error(error);
    mostrarToast('‚ùå No se pudo eliminar el equipo', 'error');
  }
}

// ‚úèÔ∏è Editar equipo (inline con actualizaci√≥n instant√°nea)
async function editarEquipoInline(id) {
  const nombreSpan = document.getElementById(`equipo-nombre-${id}`);
  const nombreActual = nombreSpan.textContent;

  const li = nombreSpan.closest('li');
  let escudoImg = li.querySelector('img');

  // Contenedor de edici√≥n
  const contenedor = document.createElement('div');
  contenedor.className = 'd-flex align-items-center gap-2';

  const input = document.createElement('input');
  input.type = 'text';
  input.value = nombreActual;
  input.className = 'form-control form-control-sm';
  input.style.width = '150px';

  const botonEscudo = document.createElement('button');
  botonEscudo.className = 'btn btn-sm btn-outline-secondary';
  botonEscudo.textContent = 'üì∑ Escudo';

  const fileInput = document.createElement('input');
  fileInput.type = 'file';
  fileInput.accept = 'image/*';
  fileInput.style.display = 'none';

  const botonGuardar = document.createElement('button');
  botonGuardar.className = 'btn btn-sm btn-success';
  botonGuardar.textContent = 'üíæ Guardar';

  const botonCancelar = document.createElement('button');
  botonCancelar.className = 'btn btn-sm btn-secondary';
  botonCancelar.textContent = '‚ùå Cancelar';

  contenedor.append(input, botonEscudo, botonGuardar, botonCancelar);
  nombreSpan.replaceWith(contenedor);

  botonEscudo.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', () => {
    const archivo = fileInput.files[0];
    if (!archivo) return;
    const preview = URL.createObjectURL(archivo);
    if (escudoImg) {
      escudoImg.src = preview;
    } else {
      escudoImg = document.createElement('img');
      escudoImg.src = preview;
      escudoImg.width = 50;
      escudoImg.height = 50;
      escudoImg.className = 'escudo-equipo';
      contenedor.parentElement.insertBefore(escudoImg, contenedor);
    }
  });

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') guardarCambios();
  });

  botonGuardar.addEventListener('click', guardarCambios);
  botonCancelar.addEventListener('click', () => contenedor.replaceWith(nombreSpan));

  async function guardarCambios() {
    const nuevoNombre = input.value.trim();
    if (!nuevoNombre) {
      mostrarToast('‚ö†Ô∏è El nombre no puede estar vac√≠o', 'warning');
      return;
    }

    const formData = new FormData();
    formData.append('nombre', nuevoNombre);
    if (fileInput.files[0]) formData.append('escudo', fileInput.files[0]);

    try {
      const res = await fetch(`${API}/equipos/${id}`, {
        method: 'PUT',
        body: formData
      });

      if (!res.ok) throw new Error('Error al guardar equipo');

      const data = await res.json();

      // üîπ Actualizar lista de equipos
      await cargarEquipos();

      // üîπ Actualizar fixture
      await cargarFixture();

      // üîπ Actualizar resultados
      await cargarResultados();

      // üîπ Actualizar tabla de posiciones
      await actualizarTablaPosiciones();

      mostrarToast('üíæ Equipo actualizado con √©xito');

    } catch (error) {
      console.error(error);
      mostrarToast('‚ùå Error al editar equipo', 'error');
    }
  }
}

// ---------- FIXTURE ----------
async function cargarFixture() {
  const res = await fetch(`${API}/fixture/${subsedeId}`);
  let fixtureData = await res.json();

  // üîπ Filtrar partidos cuyos equipos existen
  fixture = fixtureData.filter(f =>
    equipos.some(e => e.id === f.local) &&
    equipos.some(e => e.id === f.visitante)
  );

  // Ordenar por fecha y hora
  fixture.sort((a, b) => {
    const dateA = new Date(`${a.fecha}T${a.hora || '00:00'}`);
    const dateB = new Date(`${b.fecha}T${b.hora || '00:00'}`);
    return dateA - dateB;
  });

  const tbody = document.getElementById('listaFixture');
  tbody.innerHTML = '';

  // Agrupar partidos por fecha (jornadas)
  let jornadas = {};
  fixture.forEach(f => {
    if (!jornadas[f.fecha]) jornadas[f.fecha] = [];
    jornadas[f.fecha].push(f);
  });

  let jornadaNumero = 1;
  for (const fecha in jornadas) {
    const [year, month, day] = fecha.split('-');
    const fechaFormateada = `${day}/${month}/${year}`;

    // Fila de encabezado de jornada
    const headerRow = document.createElement('tr');
    headerRow.className = 'table-secondary';
    headerRow.dataset.jornada = `jornada-${jornadaNumero}`;
    headerRow.innerHTML = `
      <td colspan="6" class="text-center fw-bold">
        Jornada ${jornadaNumero} - ${fechaFormateada}
      </td>`;
    tbody.appendChild(headerRow);

    // Filas de partidos
    jornadas[fecha].forEach(f => {
      const localEquipo = equipos.find(e => e.id === f.local);
      const visitanteEquipo = equipos.find(e => e.id === f.visitante);

      const localHTML = localEquipo
        ? `<img src="${API}${localEquipo.escudo}" width="30" height="30" class="me-1 escudo-equipo"> ${localEquipo.nombre}`
        : '---';
      const visitanteHTML = visitanteEquipo
        ? `<img src="${API}${visitanteEquipo.escudo}" width="30" height="30" class="me-1 escudo-equipo"> ${visitanteEquipo.nombre}`
        : '---';

      const partidoRow = document.createElement('tr');
      partidoRow.dataset.jornada = `jornada-${jornadaNumero}`;
      partidoRow.innerHTML = `
        <td>${fechaFormateada}</td>
        <td>${f.hora || '-'}</td>
        <td>${localHTML}</td>
        <td>vs</td>
        <td>${visitanteHTML}</td>
        <td>
          <a href="partido.html?id=${f.id}" class="btn btn-sm btn-ver">Ver</a>
          <button class="btn btn-sm btn-warning" onclick="editarPartido(${f.id})">‚úèÔ∏è</button>
          <button class="btn btn-sm btn-danger" onclick="eliminarPartido(${f.id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(partidoRow);
    });

    jornadaNumero++;
  }

  // Recargar resultados despu√©s de actualizar fixture
  await cargarResultados();
}

async function descargarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "pt", "a4");

  const nombreSubsede = document.getElementById("nombreSubsede")?.textContent || "Amistad de Oro";
  doc.setFontSize(16);
  doc.text(`Fixture - ${nombreSubsede}`, 40, 40);

  let y = 70; // posici√≥n vertical inicial
  const jornadas = document.querySelectorAll("#listaFixture tr.table-secondary");

  if (jornadas.length === 0) {
    alert("No hay partidos cargados en el fixture.");
    return;
  }

  jornadas.forEach((jornada, index) => {
    const jornadaNombre = jornada.textContent.trim();
    const jornadaID = jornada.dataset.jornada;

    // t√≠tulo de jornada
    doc.setFontSize(13);
    doc.text(jornadaNombre, 40, y);
    y += 10;

    // recolectar filas de esa jornada
    const partidos = document.querySelectorAll(`#listaFixture tr[data-jornada='${jornadaID}']:not(.table-secondary)`);
    const body = [];

    partidos.forEach(tr => {
      const celdas = tr.querySelectorAll("td");
      if (celdas.length >= 5) {
        const fecha = celdas[0].innerText.trim();
        const hora = celdas[1].innerText.trim();
        const local = celdas[2].innerText.replace(/\s+/g, " ").trim();
        const vs = celdas[3].innerText.trim();
        const visitante = celdas[4].innerText.replace(/\s+/g, " ").trim();

        if (local && visitante && local !== "---" && visitante !== "---") {
          body.push([fecha, hora, local, vs, visitante]);
        }
      }
    });

    if (body.length > 0) {
      doc.autoTable({
        startY: y + 5,
        head: [["Fecha", "Hora", "Local", "vs", "Visitante"]],
        body: body,
        styles: {
          fontSize: 9,
          cellPadding: 4,
          halign: "center",
          valign: "middle",
          lineWidth: 0.1,
          lineColor: [150, 150, 150],
        },
        headStyles: {
          fillColor: [249, 174, 0],
          textColor: [0, 0, 0],
          fontStyle: "bold",
        },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        margin: { left: 40, right: 40 },
      });

      y = doc.lastAutoTable.finalY + 25;
    } else {
      y += 15;
    }

    // salto de p√°gina si la siguiente jornada no entra
    if (index < jornadas.length - 1 && y > 700) {
      doc.addPage();
      y = 60;
    }
  });

  doc.save(`fixture-${nombreSubsede}.pdf`);
}

// ---------- RESULTADOS ----------
let cacheResultados = "";
async function cargarResultados() {
  try {
    const res = await fetch(`${API}/resultados/${subsedeId}`);
    let resultadosData = await res.json();

    // üîπ Filtrar resultados cuyos equipos existen
    const resultados = resultadosData.filter(r =>
      equipos.some(e => e.id === r.local) &&
      equipos.some(e => e.id === r.visitante)
    );

    const tbody = document.getElementById('listaResultados');
    tbody.innerHTML = '';

    if (!resultados.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">A√∫n no hay resultados.</td></tr>';
      return;
    }

    // Ordenar por fecha y hora
    resultados.sort((a, b) => {
      const dateA = new Date(`${a.fecha}T${a.hora || '00:00'}`);
      const dateB = new Date(`${b.fecha}T${b.hora || '00:00'}`);
      return dateA - dateB;
    });

    // Agrupar por fecha (jornadas)
    let jornadas = {};
    resultados.forEach(r => {
      if (!jornadas[r.fecha]) jornadas[r.fecha] = [];
      jornadas[r.fecha].push(r);
    });

    let jornadaNumero = 1;
    for (const fecha in jornadas) {
      const [year, month, day] = fecha.split('-');
      const fechaFormateada = `${day}/${month}/${year}`;

      // Fila de encabezado de jornada
      const headerRow = document.createElement('tr');
      headerRow.className = 'table-secondary';
      headerRow.dataset.jornada = `jornada-${jornadaNumero}`;
      headerRow.innerHTML = `
        <td colspan="6" class="text-center fw-bold">
          Jornada ${jornadaNumero} - ${fechaFormateada}
        </td>`;
      tbody.appendChild(headerRow);

      // Filas de resultados
      jornadas[fecha].forEach(r => {
        const localEquipo = equipos.find(e => e.id === r.local) || {};
        const visitanteEquipo = equipos.find(e => e.id === r.visitante) || {};

        const localHTML = localEquipo.nombre
          ? `<img src="${API}${localEquipo.escudo}" width="30" height="30" class="me-1 escudo-equipo"> ${localEquipo.nombre}`
          : '---';
        const visitanteHTML = visitanteEquipo.nombre
          ? `<img src="${API}${visitanteEquipo.escudo}" width="30" height="30" class="me-1 escudo-equipo"> ${visitanteEquipo.nombre}`
          : '---';

        const partidoRow = document.createElement('tr');
        partidoRow.dataset.jornada = `jornada-${jornadaNumero}`;
        partidoRow.innerHTML = `
          <td>${fechaFormateada}</td>
          <td>${r.hora || '-'}</td>
          <td>${localHTML}</td>
          <td>${r.golesLocal ?? '-'}</td>
          <td>${r.golesVisitante ?? '-'}</td>
          <td>${visitanteHTML}</td>`;
        tbody.appendChild(partidoRow);
      });

      jornadaNumero++;
    }
  } catch (error) {
    console.error("Error cargando resultados:", error);
  }
}

async function descargarResultadosPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "pt", "a4");

  const nombreSubsede = document.getElementById("nombreSubsede")?.textContent || "Amistad de Oro";
  doc.setFontSize(16);
  doc.text(`Resultados - ${nombreSubsede}`, 40, 40);

  let y = 70;
  const jornadas = document.querySelectorAll("#listaResultados tr.table-secondary");

  if (jornadas.length === 0) {
    alert("No hay resultados cargados.");
    return;
  }

  jornadas.forEach((jornada, index) => {
    const jornadaNombre = jornada.textContent.trim();
    const jornadaID = jornada.dataset.jornada;

    doc.setFontSize(13);
    doc.text(jornadaNombre, 40, y);
    y += 10;

    const partidos = document.querySelectorAll(`#listaResultados tr[data-jornada='${jornadaID}']:not(.table-secondary)`);
    const body = [];

    partidos.forEach(tr => {
      const celdas = tr.querySelectorAll("td");
      if (celdas.length >= 6) {
        const fecha = celdas[0].innerText.trim();
        const hora = celdas[1].innerText.trim();
        const local = celdas[2].innerText.replace(/\s+/g, " ").trim();
        const golesLocal = celdas[3].innerText.trim();
        const golesVisitante = celdas[4].innerText.trim();
        const visitante = celdas[5].innerText.replace(/\s+/g, " ").trim();

        if (local && visitante && local !== "---" && visitante !== "---") {
          body.push([fecha, hora, local, golesLocal, golesVisitante, visitante]);
        }
      }
    });

    if (body.length > 0) {
      doc.autoTable({
        startY: y + 5,
        head: [["Fecha", "Hora", "Local", "Goles L", "Goles V", "Visitante"]],
        body: body,
        styles: {
          fontSize: 9,
          cellPadding: 4,
          halign: "center",
          valign: "middle",
          lineWidth: 0.1,
          lineColor: [150, 150, 150],
        },
        headStyles: {
          fillColor: [226, 39, 29], // rojo del club
          textColor: [255, 255, 255],
          fontStyle: "bold",
        },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        margin: { left: 40, right: 40 },
      });

      y = doc.lastAutoTable.finalY + 25;
    } else {
      y += 15;
    }

    if (index < jornadas.length - 1 && y > 700) {
      doc.addPage();
      y = 60;
    }
  });

  doc.save(`resultados-${nombreSubsede}.pdf`);
}

// ---------- AGREGAR / EDITAR PARTIDO ----------
async function agregarPartido() {
  const local = parseInt(document.getElementById('equipoLocal').value);
  const visitante = parseInt(document.getElementById('equipoVisitante').value);
  const fecha = document.getElementById('fechaPartido').value;
  const hora = document.getElementById('horaPartido').value;
  if (!local || !visitante || !fecha || !hora) return alert('Completa todos los campos');

  const partido = { subsedeId, local, visitante, fecha, hora };

  if (editandoId) {
    await fetch(`${API}/fixture/${editandoId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(partido)
    });
    editandoId = null;
    document.getElementById('btnGuardar').textContent = 'Agregar Partido';
  } else {
    await fetch(`${API}/fixture`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(partido)
    });
  }

  limpiarFormulario();
  await cargarFixture();
}

function editarPartido(id) {
  const partido = fixture.find(p => p.id === id);
  if (!partido) return;
  editandoId = id;
  document.getElementById('equipoLocal').value = partido.local;
  document.getElementById('equipoVisitante').value = partido.visitante;
  document.getElementById('fechaPartido').value = partido.fecha;
  document.getElementById('horaPartido').value = partido.hora || '';
  document.getElementById('btnGuardar').textContent = 'Guardar Cambios';
}

async function eliminarPartido(id) {
  if (!confirm('¬øSeguro que quer√©s eliminar este partido?')) return;
  await fetch(`${API}/fixture/${id}`, { method: 'DELETE' });
  await cargarFixture();
}

function limpiarFormulario() {
  document.getElementById('equipoLocal').value = '';
  document.getElementById('equipoVisitante').value = '';
  document.getElementById('fechaPartido').value = '';
  document.getElementById('horaPartido').value = '';
}

function volver() { window.location.href = 'index.html'; }

document.addEventListener('keypress', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    agregarPartido();
  }
});

(async () => {
  await cargarNombreSubsede();
  await cargarEquipos();
  await cargarFixture();
  setInterval(cargarResultados, 10000);
})();

// üî¢ TABLA DE POSICIONES

async function actualizarTablaPosiciones() {
  const res = await fetch(`${API}/resultados/${subsedeId}`);
  const resultados = await res.json();
  const tbody = document.getElementById('tablaPosiciones');
  tbody.innerHTML = '';

  if (!equipos.length || !resultados.length) {
    tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">A√∫n no hay resultados suficientes.</td></tr>';
    return;
  }

  // Inicializar estad√≠sticas
  const stats = equipos.map(eq => ({
    id: eq.id,
    nombre: eq.nombre,
    pj: 0, g: 0, e: 0, p: 0,
    gf: 0, gc: 0, dg: 0, pts: 0
  }));

  // Calcular estad√≠sticas
  resultados.forEach(r => {
    const local = stats.find(e => e.id === r.local);
    const visitante = stats.find(e => e.id === r.visitante);
    if (!local || !visitante) return;

    const gl = parseInt(r.golesLocal ?? 0);
    const gv = parseInt(r.golesVisitante ?? 0);

    local.pj++; visitante.pj++;
    local.gf += gl; local.gc += gv;
    visitante.gf += gv; visitante.gc += gl;

    if (gl > gv) { local.g++; visitante.p++; local.pts += 3; }
    else if (gl < gv) { visitante.g++; local.p++; visitante.pts += 3; }
    else { local.e++; visitante.e++; local.pts++; visitante.pts++; }
  });

  // Diferencia de gol y ordenamiento
  stats.forEach(e => e.dg = e.gf - e.gc);
  stats.sort((a, b) => b.pts - a.pts || b.dg - a.dg || b.gf - a.gf);

  // Render en tabla
  stats.forEach((e, i) => {
    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td>${i + 1}</td>
      <td>${e.nombre}</td>
      <td>${e.pj}</td>
      <td>${e.g}</td>
      <td>${e.e}</td>
      <td>${e.p}</td>
      <td>${e.gf}</td>
      <td>${e.gc}</td>
      <td>${e.dg}</td>
      <td><strong>${e.pts}</strong></td>
    `;
    tbody.appendChild(fila);
  });
}

    // üèÜ Descargar tabla de posiciones en PDF con puntos en negrita
  async function descargarPosicionesPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const tabla = document.getElementById('tablaPosiciones');
    if (!tabla || tabla.rows.length === 0) {
      alert("No hay posiciones para descargar.");
      return;
    }

    const filas = [];
    for (const row of tabla.rows) {
      const celdas = Array.from(row.cells).map(c => c.innerText);
      filas.push(celdas);
    }

    doc.text("Tabla de Posiciones", 14, 15);

    doc.autoTable({
      head: [["#", "Equipo", "PJ", "G", "E", "P", "GF", "GC", "DG", "Pts"]],
      body: filas,
      startY: 25,
      styles: { fontSize: 9 },
      headStyles: { fillColor: [249, 174, 0] },
      didParseCell: function (data) {
        // Si es la columna de puntos (√∫ltima columna), poner en negrita
        if (data.section === 'body' && data.column.index === 9) {
          data.cell.styles.fontStyle = 'bold';
        }
      }
    });

    doc.save("tabla_posiciones.pdf");
  }

    // ===========================
    // üîÅ Inicializaci√≥n
    // ===========================
    (async () => {
      await cargarNombreSubsede();
      await cargarEquipos();
      await cargarFixture();
      await actualizarTablaPosiciones();
      setInterval(() => {
        cargarResultados();
        actualizarTablaPosiciones();
      }, 10000);
    })();
</script>
</body>
</html>
