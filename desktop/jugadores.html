<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üë• Jugadores - Amistad de Oro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { background: #111; color: #eee; padding: 20px; }
    h1, h2 { color: #fff; }
    .card { background: #1e1e1e; border: 1px solid #333; border-radius: 10px; margin-top: 20px; padding: 15px; }
    .btn { border-radius: 8px; }
    input, select { background: #888787 !important; color: #fff !important; border: 1px solid #444 !important; }
    th, td { color: #eee; vertical-align: middle !important; }
    .table { border-color: #333; }
    #nombreEquipo { color: rgb(255, 255, 255); font-size: 2rem; font-weight: 700; }
  </style>
</head>
<body>
  <div class="container mb-3">
    <div class="d-flex align-items-center gap-2">
      <h1 class="mb-0">üë• Jugadores</h1>
      <h1 id="nombreEquipo" class="mb-0">Cargando...</h3>
    </div>
  </div>

  <div class="container">
    <div class="d-flex justify-content-between mb-3">
      <button class="btn btn-secondary" onclick="volver()">‚¨ÖÔ∏è Volver</button>
      <div>
        <button class="btn btn-success me-2" onclick="descargarPDF()">üìÑ PDF</button>
        <button class="btn btn-primary" onclick="descargarExcel()">üìä Excel</button>
      </div>
    </div>

    <!-- üìã FORMULARIO -->
    <div class="card">
      <h2>Agregar jugador</h2>
      <div class="row g-2">
        <div class="col-md-2"><input type="number" id="numeroCamiseta" class="form-control" placeholder="N¬∞ camiseta"></div>
        <div class="col-md-2"><input type="text" id="nombre" class="form-control" placeholder="Nombre"></div>
        <div class="col-md-2"><input type="text" id="apellido" class="form-control" placeholder="Apellido"></div>
        <div class="col-md-3"><input type="date" id="fechaNacimiento" class="form-control"></div>
        <div class="col-md-2"><input type="number" id="documento" class="form-control" placeholder="DNI"></div>
        <div class="col-md-1 d-grid"><button class="btn btn-success" onclick="agregarJugador()">Agregar</button></div>
      </div>
    </div>

    <!-- üìú TABLA -->
    <div class="card mt-4">
      <h2>Lista de jugadores</h2>
      <table class="table table-dark table-striped mt-3" id="tablaJugadores">
        <thead>
          <tr>
            <th>N¬∞</th>
            <th>Nombre completo</th>
            <th>Fecha de nacimiento</th>
            <th>Edad</th>
            <th>DNI</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="listaJugadores"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API = 'http://localhost:3000';
    const params = new URLSearchParams(window.location.search);
    const equipoId = parseInt(params.get('equipoId'));
    let jugadores = [];
    let subsedeId = parseInt(params.get('subsedeId'));

    // üßæ Obtener nombre del equipo
    async function cargarNombreEquipo() {
      try {
        const res = await fetch(`${API}/equipos/${equipoId}/equipo`);
        if (!res.ok) throw new Error('Error al obtener equipo');
        const equipo = await res.json();
        document.getElementById('nombreEquipo').textContent = `${equipo.nombre}`;
        subsedeId = equipo.subsedeId; // üîπ Guardamos el ID de la subsede
      } catch (error) {
        console.error('Error al cargar el nombre del equipo:', error);
        document.getElementById('nombreEquipo').textContent = 'Equipo desconocido';
      }
    }

    // üßÆ Calcular edad
    function calcularEdad(fecha) {
      if (!fecha) return '';
      const nacimiento = new Date(fecha);
      const hoy = new Date();
      let edad = hoy.getFullYear() - nacimiento.getFullYear();
      const m = hoy.getMonth() - nacimiento.getMonth();
      if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) edad--;
      return edad;
    }

    // üìÖ Ajustar y formatear fecha
    function ajustarFechaLocal(fechaISO) {
      if (!fechaISO) return '';
      const fecha = new Date(fechaISO);
      const fechaLocal = new Date(fecha.getTime() + fecha.getTimezoneOffset() * 60000);
      return fechaLocal.toISOString().split('T')[0];
    }

    function formatearFecha(fechaISO) {
      if (!fechaISO) return '';
      const f = new Date(fechaISO);
      const fechaLocal = new Date(f.getTime() + f.getTimezoneOffset() * 60000);
      const dia = String(fechaLocal.getDate()).padStart(2, '0');
      const mes = String(fechaLocal.getMonth() + 1).padStart(2, '0');
      const anio = fechaLocal.getFullYear();
      return `${dia}/${mes}/${anio}`;
    }

    // üîπ CARGAR JUGADORES
    async function cargarJugadores() {
      const res = await fetch(`${API}/jugadores/${equipoId}`);
      jugadores = await res.json();
      jugadores.sort((a, b) => a.numeroCamiseta - b.numeroCamiseta);
      renderJugadores();
    }

    // üîπ RENDERIZAR TABLA
    function renderJugadores() {
      const tbody = document.getElementById('listaJugadores');
      tbody.innerHTML = '';
      jugadores.forEach(j => {
        const tr = document.createElement('tr');
        const fechaFormateada = formatearFecha(j.fechaNacimiento);
        tr.innerHTML = `
          <td>${j.numeroCamiseta}</td>
          <td>${j.nombre} ${j.apellido}</td>
          <td>${fechaFormateada}</td>
          <td>${calcularEdad(j.fechaNacimiento)}</td>
          <td>${j.documento}</td>
          <td>
            <button class="btn btn-sm btn-primary me-2" onclick="editarJugador(${j.id})">‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="eliminarJugador(${j.id})">‚ùå</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // üîπ AGREGAR JUGADOR
    async function agregarJugador() {
      const numeroCamiseta = document.getElementById('numeroCamiseta').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      const apellido = document.getElementById('apellido').value.trim();
      const fechaNacimiento = document.getElementById('fechaNacimiento').value.trim();
      const documento = document.getElementById('documento').value.trim();

      if (!numeroCamiseta || !nombre || !apellido || !fechaNacimiento || !documento)
        return alert('Complet√° todos los campos');

      await fetch(`${API}/jugadores`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ equipoId, nombre, apellido, fechaNacimiento, documento, numeroCamiseta })
      });

      document.getElementById('numeroCamiseta').value = '';
      document.getElementById('nombre').value = '';
      document.getElementById('apellido').value = '';
      document.getElementById('fechaNacimiento').value = '';
      document.getElementById('documento').value = '';

      cargarJugadores();
    }

    // üîπ ELIMINAR JUGADOR
    async function eliminarJugador(id) {
      if (!confirm('¬øEliminar este jugador?')) return;
      await fetch(`${API}/jugadores/${id}`, { method: 'DELETE' });
      cargarJugadores();
    }

    // üîπ EDITAR JUGADOR
    async function editarJugador(id) {
      const j = jugadores.find(x => x.id === id);
      const fila = document.querySelector(`#listaJugadores tr:nth-child(${jugadores.indexOf(j) + 1})`);
      fila.innerHTML = `
        <td><input type="number" class="form-control" id="edit-numero" value="${j.numeroCamiseta}"></td>
        <td>
          <input type="text" class="form-control mb-1" id="edit-nombre" value="${j.nombre}">
          <input type="text" class="form-control" id="edit-apellido" value="${j.apellido}">
        </td>
        <td><input type="date" class="form-control" id="edit-fecha" value="${ajustarFechaLocal(j.fechaNacimiento)}"></td>
        <td>${calcularEdad(j.fechaNacimiento)}</td>
        <td><input type="number" class="form-control" id="edit-dni" value="${j.documento}"></td>
        <td>
          <button class="btn btn-sm btn-success me-2" onclick="guardarEdicion(${id})">üíæ</button>
          <button class="btn btn-sm btn-secondary" onclick="cargarJugadores()">‚ùå</button>
        </td>`;

      const camposEdit = ['edit-numero', 'edit-nombre', 'edit-apellido', 'edit-fecha', 'edit-dni'];
      camposEdit.forEach(campoId => {
        const input = document.getElementById(campoId);
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            guardarEdicion(id);
          }
        });
      });
    }

    // üîπ GUARDAR EDICI√ìN
    async function guardarEdicion(id) {
      const numeroCamiseta = document.getElementById('edit-numero').value.trim();
      const nombre = document.getElementById('edit-nombre').value.trim();
      const apellido = document.getElementById('edit-apellido').value.trim();
      const fechaNacimiento = document.getElementById('edit-fecha').value.trim();
      const documento = document.getElementById('edit-dni').value.trim();

      await fetch(`${API}/jugadores/${id}`, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ nombre, apellido, fechaNacimiento, documento, numeroCamiseta })
      });

      cargarJugadores();
    }

    // üîô VOLVER
    function volver() {
      if (subsedeId) {
        window.location.href = `subsede.html?id=${subsedeId}`;
      } else {
        window.location.href = 'index.html';
      }
    }

    // üìÑ PDF
function descargarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

  const margen = 40;
  let y = 60; // posici√≥n vertical inicial
  const padding = 10; // espacio extra dentro de la celda
  const rowHeight = 20;

  // üîπ Cabecera
  const equipo = document.getElementById('nombreEquipo').textContent;
  doc.setFont('helvetica', 'bold');
  doc.setFontSize(16);
  doc.setTextColor(0, 0, 0);
  doc.text('Jugadores', margen, y);
  doc.text(equipo, 550, y, { align: 'right' });
  y += 30;

  // üîπ Preparar tabla
  const headers = ['N¬∞', 'Nombre completo', 'Fecha de nacimiento', 'Edad', 'DNI'];

  // Ajustar ancho de columnas autom√°ticamente seg√∫n contenido
  const colWidths = headers.map((header, i) => {
    if (header === 'DNI') return 80; // ancho fijo para DNI

    // obtener el ancho m√°ximo entre encabezado y datos
    let maxWidth = doc.getTextWidth(header);
    jugadores.forEach(j => {
      let text = '';
      if (i === 0) text = String(j.numeroCamiseta);
      else if (i === 1) text = `${j.nombre} ${j.apellido}`;
      else if (i === 2) text = formatearFecha(j.fechaNacimiento);
      else if (i === 3) text = String(calcularEdad(j.fechaNacimiento));
      const w = doc.getTextWidth(text);
      if (w > maxWidth) maxWidth = w;
    });
    return maxWidth + padding * 2;
  });

  // üîπ Encabezado de tabla
  let x = margen;
  headers.forEach((header, i) => {
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.rect(x, y, colWidths[i], rowHeight); // borde
    doc.text(header, x + padding, y + 14);
    x += colWidths[i];
  });
  y += rowHeight;

  // üîπ Filas de jugadores
  const ordenados = [...jugadores].sort((a,b) => a.numeroCamiseta - b.numeroCamiseta);
  ordenados.forEach(j => {
    x = margen;
    const rowData = [
      j.numeroCamiseta,
      `${j.nombre} ${j.apellido}`,
      formatearFecha(j.fechaNacimiento),
      calcularEdad(j.fechaNacimiento),
      j.documento
    ];

    rowData.forEach((cell, i) => {
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(11);
      doc.setTextColor(0, 0, 0);
      doc.rect(x, y, colWidths[i], rowHeight);
      doc.text(String(cell), x + padding, y + 14);
      x += colWidths[i];
    });
    y += rowHeight;
  });

  doc.save('jugadores.pdf');
}

    // üìä EXCEL
function descargarExcel() {
  const equipo = document.getElementById('nombreEquipo').textContent;
  const data = jugadores.map(j => ({
    'N¬∞': j.numeroCamiseta,
    'Nombre completo': `${j.nombre} ${j.apellido}`,
    'Fecha de nacimiento': formatearFecha(j.fechaNacimiento),
    'Edad': calcularEdad(j.fechaNacimiento),
    'DNI': j.documento
  }));

  const ws = XLSX.utils.json_to_sheet(data, { skipHeader: false });

  // üîπ Ajustar ancho de columnas
  const colWidths = [];

  // Calcular ancho autom√°tico excepto DNI
  const headers = ['N¬∞', 'Nombre completo', 'Fecha de nacimiento', 'Edad', 'DNI'];
  headers.forEach((header, i) => {
    if (header === 'DNI') {
      colWidths.push({ wch: 12 }); // ancho fijo para DNI
    } else {
      // ancho m√°ximo entre encabezado y datos
      let maxLength = header.length;
      data.forEach(row => {
        const value = row[header] ? String(row[header]) : '';
        if (value.length > maxLength) maxLength = value.length;
      });
      colWidths.push({ wch: maxLength + 2 }); // un poco de padding
    }
  });

  ws['!cols'] = colWidths;

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Jugadores");
  XLSX.writeFile(wb, "jugadores.xlsx");
}

    const inputsJugador = ['numeroCamiseta', 'nombre', 'apellido', 'fechaNacimiento', 'documento'];
    inputsJugador.forEach(id => {
      const input = document.getElementById(id);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          agregarJugador();
        }
      });
    });

    cargarNombreEquipo();
    cargarJugadores();
  </script>
</body>
</html>
